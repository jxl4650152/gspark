<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>G-Spark</title>
    <link rel="stylesheet" href="{{url_for("static", filename = "job.css" )}}" type="text/css">
    <script src="https://d3js.org/d3.v4.min.js"></script>

</head>
<body>
<div class="Top-bar">
    <h1>G-Spark</h1>
</div>

<nav id="navigator">

    <ul class="menu-ul">
        <li class="menu"><a href="/gspark/intro">简 介</a></li>
        <li class="memu-li"><a href="/gspark/clusters/">集 群</a></li>
        <li class="memu-li"><a  href="#">作 业</a></li>
    </ul>
    <ul class="submenu-ul">
        <li class="submenu-li">
            <span class="submenu-span">正在执行</span>
            <ul class="job-list-ul">
                {% for job in RunningJobs %}
                    <li ><a class="running-job" href="/gspark/jobs/runningjobs/{{ job.id }}">{{ job.name }}</a></li>
                {% endfor %}
            </ul>
        </li>
    </ul>
    <ul class="submenu-ul">
        <li class="submenu-li">
            <span class="submenu-span">历史作业</span>
            <ul class="job-list-ul">
                {% for job in HistoryJobs %}
                    <li ><a class="history-job" href="/gspark/jobs/historyjobs/{{ job.id }}">{{ job.name }}</a></li>
                {% endfor %}
            </ul>
        </li>
    </ul>

</nav>

<div class="zuoye" id="main-body" >
    <p id="id">作业编号：{{ jobID }} <input type="button" value="test1" onclick="fireTest1()"><input type="button" value="test2" onclick="fireTest2()"></p>
    <svg class="out-container"  height="1000" width="{{ (job.clouds)|length * CloudWidth + ((job.clouds)|length + 2) * 40  }}" >
        {% for cloud in job.clouds %}
            <g class="cloud-svg-group" transform="translate({{ loop.index0 * (CloudWidth + 20) }}, 0)">

                    <svg class="cloud-svg"   id="{{ cloud.name }}"  width="{{ CloudWidth + 60}}" height="500" >
                        <g transform="translate(30, 20)">
                            <g>
                                <rect class="cloud-rect" x="0" y="0" rx="15"  ry="15" width="{{ CloudWidth - 15 }}" height="450"
                                    style="fill:blue;fill-opacity:0.1;
                                        stroke-opacity:0.9">
                                </rect>
                                <text x="17" y="30">{{ cloud.name }}</text>
                            </g>
                        {% if cloud.nodes[0].components|length == 2 %}
                            <g>
                                <rect class="node-rect" x="42.5" y="50" rx="15"  ry="15" width="180" height="180"
                                      style="stroke-opacity:0.9">
                                </rect>
                                <text  transform="translate(30, 170)rotate(-90)">{{ cloud.nodes[0].host }}</text>
                            </g>
                            <g>
                                <rect  id="{{ cloud.nodes[0].components[0] }}" x="57.5" y="60" rx="15"  ry="15" width="150" height="50"
                                    style="fill:blue;fill-opacity:0.1;
                            stroke-opacity:0.9">
                                </rect>
                                <text x="95" y="85">{{ cloud.nodes[0].components[0] }}</text>
                            </g>
                            <g class="site-master" style="z-index: 1">
                                <rect  id="{{ cloud.nodes[0].components[1] }}" x="57.5" y="170" rx="15"  ry="15" width="150" height="50"
                                    style="fill:blue;fill-opacity:0.1;stroke-opacity:0.9">
                                </rect>
                                <text x="95" y="200">{{ cloud.nodes[0].components[1] }}</text>
                            </g>
                        {% else %}
                            <g>
                                <rect class="node-rect" x="42.5" y="100" rx="15"  ry="15" width="180" height="130"
                                        style="stroke-opacity:0.9">
                                </rect>
                                <text transform="translate(30, 180)rotate(-90)">{{ cloud.nodes[0].host }}</text>
                            </g>
                            <g class="site-master" style="z-index: 1">
                                <rect  id="{{ cloud.nodes[0].components[0] }}" x="57.5" y="170" rx="15"  ry="15" width="150" height="50"
                                    style="fill:blue;fill-opacity:0.1;stroke-opacity:0.9">
                                </rect>
                                <text x="95" y="200">{{ cloud.nodes[0].components[0] }}</text>
                            </g>
                        {% endif %}
                            <g class="bottom-nodes" transform="translate(0, 280)" style="z-index: 0">
                                {% for i in range(1, cloud.nodes|length) %}
                                    {% if i % 2 != 0 %}
                                        <g class="left-colum-node" transform="translate(10, {{ (i//2)* 190 }})">
                                    {% else %}
                                        <g class="right-colum-node" transform="translate(155, {{ (i//2-1)* 190 }})">
                                    {% endif %}
                                            <g>
                                                <rect  class="node-rect"  rx="10"  ry="10" width="100" height="150" ></rect>
                                                <text x="8" y="-8">{{ cloud.nodes[i].host }}</text>
                                            </g>
                                            {% for ex in range(cloud.nodes[i].components|length) %}
                                                <g transform="translate(8, {{ ex * 45 + 10  }})">
                                                    <rect id="{{ cloud.nodes[i].components[ex] }}" class="ex-rect"    rx="10"  ry="10" width="85" height="40"
                                                            style="stroke-opacity:0.9"></rect>
                                                    <text x="3" y="20">{{ cloud.nodes[i].components[ex] }}</text>
                                                </g>
                                            {% endfor %}
                                        </g>
                                {% endfor %}
                             </g>
                            <g class="middle-paths"></g>
                            <g class="middle-circles"></g>
                            <g class="bottom-paths"></g>
                            <g class="bottom-circles"></g>
                            </g><!--translate-->
                        </svg>
                </g><!--cloud-svg-group-->
            {% endfor %}
        <g class="g_s_path_group"></g>
    </svg><!--out-cotainner-->
    <div id="progress-div">
        <svg   class="progress-svg"  width="100%" height="100">
            <text y="55", x="15">进度: {{ job.progress }}%</text>
            <rect class="progress-bar" x="90" y="40" rx="15"  ry="15" width="1000" height="20"
                style="fill:blue;fill-opacity:0.1;stroke:blue; stroke-opacity:0.9">
            </rect>
            <rect class="progress" x="90" y="40" rx="15"  ry="15" width="{{ job.progress * 10 }}" height="20"
                style="fill:green; stroke:blue; stroke-opacity:0.9">
            </rect>
        </svg>
    </div>
    <div>
        <svg   id="line" height="5">
        <line x1="0" y1="0" x2="100%" y2="0"
              style="stroke:rgb(39, 47, 68);stroke-width:2">
        </line>
        </svg>
    </div>
    <p class="stage-summary">Stage 统计</p>
    <table border="1">
        <thead>
        <tr>
            <th>stageID</th>
            <th></th>
            <th>用时</th>
            <th></th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        </tbody>
    </table>
    <p class="shuffle-summary">Shuffle 统计</p>
    <table border="1">
        <thead>
        <tr>
            <th>shuffleID</th>
            <th>数据传输量</th>
            <th>用时</th>
            <th></th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        </tbody>
    </table>
</div>
<script>
        //set cloud-rect height to the same value
        var container_svg = document.getElementsByClassName("cloud-svg");
        var height_array = new Array(container_svg.length);
        Array.from(container_svg).forEach(function (item, index) {
            var bbox = item.getBBox();
            height_array[index] = bbox.y + bbox.height;
        });
        var max_height = Math.max.apply(Math, height_array);
        Array.from(container_svg).forEach(function (item) {
            var rect = item.getElementsByClassName("cloud-rect").item(0);
            rect.setAttribute("height", max_height + "px");
            item.setAttribute("height", max_height + 60 + "px");
        });


        //set width values of top-bar and line to fill the window
        var body = document.getElementsByTagName("body").item(0);
        var out_svg = document.getElementsByClassName("out-container").item(0);
        var nav = document.getElementById("navigator");
        var line = document.getElementById("line");
        var bbox = out_svg.getBBox();
        var nav_width = parseInt(document.defaultView.getComputedStyle(nav, null).getPropertyValue("width"), 10);
        var body_width = parseInt(document.defaultView.getComputedStyle(body, null).getPropertyValue("width"), 10);
        out_svg.setAttribute("height",bbox.y + bbox.height + "px");
        if(body_width > bbox.x + bbox.width + nav_width){
            line.setAttribute("width", body_width  + "px");
        }else{
            line.setAttribute("width", bbox.x + bbox.width  + "px");
        }

        /**
         * get element two elements' width and height, get offset-x and offset-y of the
         * @param ele1 HTMLelement
         * @param ele2  HTMLelement
         * @returns {[number,number,number,number,number,number]} [width1, height1, x, y, width2, height2]
         */
        function getLoc(ele1, ele2){

                    var loc = [0, 0, 0, 0];

                    var ele1Rect = ele1.getBoundingClientRect();
                    var ele2Rect = ele2.getBoundingClientRect();

                    loc[0] = ele1Rect.width;
                    loc[1] = ele1Rect.height;
                    loc[2] = ele2Rect.left - ele1Rect.left;
                    loc[3] = ele2Rect.top - ele1Rect.top;
                    loc[4] = ele2Rect.width;
                    loc[5] = ele2Rect.height;

                    return loc;
                }
        function AddLinkV(ele, point1, point2, type){
            var newpath = document.createElementNS("http://www.w3.org/2000/svg", "path");
            if(type === 1) {
                newpath.setAttribute("d", "M" + point1[0] + "," + point1[1] + "C" + point1[0] + "," + ((point2[1] - point1[1]) / 2 + point1[1]) +
                    " " + point2[0] + "," + point1[1] + " " + point2[0] + "," + point2[1]);
                newpath.setAttribute("class", "g_s_path");
            }else if(type === 2){
                newpath.setAttribute("d", "M" + point1[0] + "," + point1[1] + "Q" + point1[0] + "," + point2[1] + " " +  point2[0] + "," + point2[1]);
                newpath.setAttribute("class", "executor-path");
            }
            ele.appendChild(newpath);
}
        function AddTopPaths(SiteArray){

            var sites = SiteArray;
            var outcontainer = document.getElementsByClassName("out-container")[0];
            var g = document.getElementsByClassName("g_s_path_group")[0];
            var GlobalDriver = document.getElementById("GlobalDriver");
            var Gout = getLoc(outcontainer,GlobalDriver);
            var GlobalLoc = [Gout[2] + Gout[4]/2, Gout[3] + Gout[5]];


            sites.forEach(function(item, index, array){
                var temp = document.getElementById(item);
                var newcircle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                newcircle.setAttribute("cx", Gout[2] + Gout[4]/2);
                newcircle.setAttribute("cy", Gout[3] + Gout[5]);
                newcircle.setAttribute("r", 0);
                newcircle.setAttribute("class","top-circle" );


                var loc = getLoc(outcontainer, temp);
                var p2 = [loc[2] + loc[4]/2, loc[3]];
                AddLinkV(g, GlobalLoc, p2, 1);
                g.appendChild(newcircle);

            });

    }
        function PathsGrow(PathsClassName, time){
        var paths = document.getElementsByClassName(PathsClassName);
        var classname = "." + PathsClassName;

        Array.from(paths).forEach(function (path, index, a) {
            var totalLength = path.getTotalLength();
            path.setAttribute("stroke-dasharray", totalLength + " " + totalLength);
            path.setAttribute("stroke-dashoffset", totalLength );
            path.style.visibility = "visible";

        });

        d3.selectAll(classname)
            .transition()
            .duration(time)
            .attr("stroke-dashoffset", 0);


    }
        function connectTwoIds(ele, id1, id2, type){
            console.log(ele, ele.nodeType, id1, id2);
            var ele1 = ele.getElementById(id1);
            var ele2 = ele.getElementById(id2);
            var pos1 = getLoc(ele, ele1);
            var pos2 = getLoc(ele, ele2);
            var paths_g = ele.getElementsByClassName("middle-paths")[0];
            if(type === 1) {
                if (pos2[2] > pos1[2]) {
                    AddLinkV(paths_g, [pos1[2] + pos1[4] / 2, pos1[3] + pos1[5]], [pos2[2], pos2[3] + pos2[5] / 2], 2);
                } else {
                    AddLinkV(paths_g, [pos1[2] + pos1[4] / 2, pos1[3] + pos1[5]], [pos2[2] + pos2[4], pos2[3] + pos2[5] / 2], 2);
                }
            }else{
            }

        }
        function connectSiteToEx(siteId, exArr) {
            var site_svg = document.getElementById(siteId);
            while(site_svg && (site_svg.getAttribute("class") !== "cloud-svg")){
                site_svg = site_svg.parentNode;
            }
            var cloud_rect = site_svg.getElementsByClassName("cloud-rect")[0];
            var circle_g = site_svg.getElementsByClassName("middle-circles")[0];
            var site = document.getElementById(siteId);
            var pos = getLoc(cloud_rect,site);

            console.log(circle_g);


            for(var i = 0; i < exArr.length; i++){
                var newcircle = document.createElementNS("http://www.w3.org/2000/svg", "circle");

                newcircle.setAttribute("cx", pos[2] + pos[4]/2);
                newcircle.setAttribute("cy", pos[3] + pos[5]);
                newcircle.setAttribute("r", "0");
                newcircle.setAttribute("class","middle-circle" );

                connectTwoIds(site_svg, siteId, exArr[i], 1);
                circle_g.insertBefore(newcircle,null);
            }
        }
        function topCircleMove() {
            var paths = document.getElementsByClassName("g_s_path");

            d3.selectAll(".top-circle")
                .attr("r", 5)
                .transition()
                .duration(3000)
                .attrTween("cx", function (d, i, a) {
                    var len = paths[i].getTotalLength();
                    return function (t) {
                        var p = paths[i].getPointAtLength((t) * len);

                        return p.x;
                    };
                })
                .attrTween("cy", function (d, i, a) {
                    var len = paths[i].getTotalLength();
                    return function (t) {
                        var p = paths[i].getPointAtLength((t) * len);

                        return p.y;
                    };
                })
                .on("end", middleCircleMove)
                .on("start", PathsGrow("g_s_path", 3000))
                .remove();

        }
        function middleCircleMove() {
            var paths = document.getElementsByClassName("executor-path");
            d3.selectAll(".middle-circle")
                .attr("r", 4)
                .transition()
                .duration(3000)
                .attrTween("cx", function (d, i, a) {
                    var len = paths[i].getTotalLength();
                    return function (t) {
                        var p = paths[i].getPointAtLength((t) * len);
                        return p.x;
                    };
                })
                .attrTween("cy", function (d, i, a) {
                    var len = paths[i].getTotalLength();
                    return function (t) {
                        var p = paths[i].getPointAtLength((t) * len);
                        return p.y;
                    };
                })
                .on("start", PathsGrow("executor-path", 3000));

        }

        function fireTest1() {


        var test = ["SiteDriver0", "SiteDriver1",  "SiteDriver2"];
        AddTopPaths(test);

        connectSiteToEx("SiteDriver0", ["executor0","executor1","executor2","executor3","executor4","executor5","executor6","executor7"]);
        connectSiteToEx("SiteDriver1", ["executor1","executor2","executor4"]);
        connectSiteToEx("SiteDriver2", ["executor0","executor3","executor5","executor6","executor7","executor8"]);
        topCircleMove();
        }

        function fireTest2() {


        var test = ["SiteDriver0", "SiteDriver1", "SiteDriver3"];
        AddTopPaths(test);
        connectSiteToEx("SiteDriver0", ["executor0","executor1","executor2","executor3","executor4"]);
        connectSiteToEx("SiteDriver1", ["executor1","executor2","executor4"]);
        connectSiteToEx("SiteDriver3", ["executor0","executor3","executor5","executor6","executor7","executor8"]);
        topCircleMove();
        }

    </script>

</body>
</html>